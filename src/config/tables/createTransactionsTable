create table public.transactions (
  id uuid primary key default gen_random_uuid(),

  user_id uuid not null
    references users(id)
    on delete cascade,

  budget_id uuid not null
    references budgets(id)
    on delete cascade,

  amount numeric(12, 2) not null
    check (amount > 0),

  type text not null
    check (type in ('expense', 'income')),

  description text,

  category text,

  transaction_date date not null,

  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create index idx_transactions_user_id on transactions(user_id);
create index idx_transactions_budget_id on transactions(budget_id);
create index idx_transactions_date on transactions(transaction_date);

-- Trigger to update budget spent amount when transaction is added, updated, or deleted
create or replace function update_budget_spent()
returns trigger as $$
declare
  target_budget_id uuid;
begin
  -- Determine which budget_id to use
  if (TG_OP = 'DELETE') then
    target_budget_id := old.budget_id;
  else
    target_budget_id := new.budget_id;
  end if;

  update budgets
  set spent = (
    select coalesce(sum(amount), 0)
    from transactions
    where budget_id = target_budget_id
      and type = 'expense'
  )
  where id = target_budget_id;

  return null;
end;
$$ language plpgsql;


drop trigger if exists trg_update_budget_spent on transactions;

create trigger trg_update_budget_spent
after insert or update or delete
on transactions
for each row
execute function update_budget_spent();

-- Trigger to update budget amount when transaction is added, updated, or deleted - INCOME
create or replace function sync_budget_amount_from_transactions()
returns trigger
language plpgsql
as $$
begin
  -- INSERT
  if tg_op = 'INSERT' then
    if new.type = 'income' then
      update budgets
      set amount = amount + new.amount
      where id = new.budget_id;
    end if;
    return new;
  end if;

  -- DELETE
  if tg_op = 'DELETE' then
    if old.type = 'income' then
      update budgets
      set amount = amount - old.amount
      where id = old.budget_id;
    end if;
    return old;
  end if;

  -- UPDATE
  if tg_op = 'UPDATE' then
    -- income → income (adjust difference)
    if old.type = 'income' and new.type = 'income' then
      update budgets
      set amount = amount + (new.amount - old.amount)
      where id = new.budget_id;

    -- income → expense (remove income)
    elsif old.type = 'income' and new.type = 'expense' then
      update budgets
      set amount = amount - old.amount
      where id = old.budget_id;

    -- expense → income (add income)
    elsif old.type = 'expense' and new.type = 'income' then
      update budgets
      set amount = amount + new.amount
      where id = new.budget_id;
    end if;

    return new;
  end if;

  return null;
end;
$$;
